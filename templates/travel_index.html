<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wanderlust AI - Best Travel Time</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='travel_style.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;800&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Wanderlust AI</h1>
            <p class="subtitle">Pick any city on the map to discover its perfect season.</p>
        </header>

        <!-- Map Container -->
        <div id="map"></div>

        <form action="/" method="POST" class="search-box" id="analysis-form">
            <!-- Visible Search Input -->
            <input type="text" name="city" id="input-city" class="search-input" placeholder="Enter a city name..."
                autocomplete="off">

            <input type="hidden" name="lat" id="input-lat">
            <input type="hidden" name="lon" id="input-lon">

            <button type="submit" class="btn-main" id="btn-analyze">Analyze Trip</button>
        </form>

        {% if result %}
        <div class="results-container">
            <!-- 1. Top Row: Best Time & Scores -->
            <div class="dashboard-grid">
                <div class="card recommendation-card">
                    <h2>Best Time to Visit</h2>
                    <div class="best-month">{{ result.best_month }}</div>
                    <p class="score-summary">Analysis based on Weather, Crowds, and Cost.</p>
                </div>

                <div class="card scores-card">
                    <h3>Compatibility Score</h3>
                    <div class="scores-list">
                        <div class="score-row">
                            <span class="score-label-text">‚òÄÔ∏è Weather</span>
                            <div class="progress-bar">
                                <div class="progress-fill weather-fill" style="width: {{ result.scores.weather }}%;">
                                </div>
                            </div>
                            <span class="score-val">{{ result.scores.weather }}%</span>
                        </div>
                        <div class="score-row">
                            <span class="score-label-text">üë• Comfort</span>
                            <div class="progress-bar">
                                <div class="progress-fill crowd-fill" style="width: {{ result.scores.crowd }}%;"></div>
                            </div>
                            <span class="score-val">{{ result.scores.crowd }}%</span>
                        </div>
                        <div class="score-row">
                            <span class="score-label-text">üí∞ Value</span>
                            <div class="progress-bar">
                                <div class="progress-fill cost-fill" style="width: {{ result.scores.cost }}%;"></div>
                            </div>
                            <span class="score-val">{{ result.scores.cost }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Middle Row: Accommodation & Tips -->
            <div class="dashboard-grid secondary-row">
                <div class="card hotel-card">
                    <h3>üè® Where to Stay</h3>
                    <div class="hotel-buttons-vertical">
                        <a href="{{ result.hotels.booking }}" target="_blank" class="btn-hotel booking">Booking.com</a>
                        <a href="{{ result.hotels.airbnb }}" target="_blank" class="btn-hotel airbnb">Airbnb</a>
                        <a href="{{ result.hotels.google_hotels }}" target="_blank" class="btn-hotel google">Google
                            Hotels</a>
                    </div>
                </div>

                <div class="card tips-card">
                    <h3>üí° Smart Tips</h3>
                    <ul class="tips-list-compact">
                        {% for tip in result.tips %}
                        <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- 3. Bottom Section: Attraction Map & Cards -->
            <h3 class="section-title">Top Attractions</h3>
            <div class="attraction-layout">
                <div id="city-map"></div>

                <div class="attraction-grid">
                    {% for attraction in result.attractions %}
                    <div class="attraction-card">
                        <div class="attr-header">
                            <strong>{{ attraction.title }}</strong>
                            <span class="badgem">{{ attraction.dist }}m</span>
                        </div>
                        <p class="attr-desc">{{ attraction.description[:100] }}...</p>
                        <a href="{{ attraction.ticket_link }}" target="_blank"
                            class="btn-ticket-sm {% if attraction.is_free %}btn-free{% endif %}">
                            {{ attraction.ticket_text }}
                        </a>
                    </div>
                    {% else %}
                    <p>No attractions found.</p>
                    {% endfor %}
                </div>
                <br>



            </div>
        </div>
        {% endif %}
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // Init Main Map (World)
        var map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            className: 'map-tiles'
        }).addTo(map);

        // --- ATTRACTION MAP LOGIC ---
        {% if result and result.attractions %}
        var cityMap = L.map('city-map');
        // Center on the first attraction or the city center
        var centerLat = {{ result.lat }};
        var centerLon = {{ result.lon }};

        cityMap.setView([centerLat, centerLon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            className: 'map-tiles'
        }).addTo(cityMap);

        // Add markers
        var attractions = {{ result.attractions | tojson }};
        attractions.forEach(function (attr) {
            if (attr.lat && attr.lon) {
                L.marker([attr.lat, attr.lon])
                    .addTo(cityMap)
                    .bindPopup("<b>" + attr.title + "</b><br>" + (attr.is_free ? "Free" : "Ticket Required"));
            }
        });
        {% endif %}
        // ----------------------------

        // Add Search Control (Optional now, but kept for map interactivity)
        L.Control.geocoder({
            defaultMarkGeocode: false
        })
            .on('markgeocode', function (e) {
                var bbox = e.geocode.bbox;
                var poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]).addTo(map);
                map.fitBounds(poly.getBounds());

                handleLocationSelect(e.geocode.center, e.geocode.name);
            })
            .addTo(map);

        var marker;

        function handleLocationSelect(latlng, name) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(latlng).addTo(map);

            // Update Form
            document.getElementById('input-lat').value = latlng.lat;
            document.getElementById('input-lon').value = latlng.lng;

            // Update Visible Input
            // Clean up name (use comma split for brevity)
            var cleanName = name.split(',')[0];
            document.getElementById('input-city').value = cleanName;
        }

        map.on('click', function (e) {
            // Reverse Geocoding via Nominatim
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    var cityName = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.country || "Unknown Location";
                    if (cityName === "Unknown Location" && data.display_name) {
                        cityName = data.display_name.split(',')[0];
                    }
                    handleLocationSelect(e.latlng, cityName);
                })
                .catch(error => {
                    console.error("Geocoding error:", error);
                    handleLocationSelect(e.latlng, "Selected Location");
                });
        });

        // --- FORM SUBMISSION LOGIC ---
        document.getElementById('analysis-form').addEventListener('submit', function (e) {
            var lat = document.getElementById('input-lat').value;
            var lon = document.getElementById('input-lon').value;
            var cityInput = document.getElementById('input-city').value;
            var btn = document.getElementById('btn-analyze');

            if (!cityInput) {
                e.preventDefault();
                alert("Please enter a city name.");
                return;
            }

            // If we have coordinates, let the form submit naturally
            if (lat && lon) {
                btn.innerText = "Analyzing...";
                return;
            }

            // If we DON'T have coordinates but have a city name, Geocode it first
            e.preventDefault(); // Stop form from submitting immediately
            btn.innerText = "Locating...";

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityInput)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var place = data[0];
                        document.getElementById('input-lat').value = place.lat;
                        document.getElementById('input-lon').value = place.lon;

                        // Now submit the form manually
                        btn.innerText = "Analyzing...";
                        e.target.submit();
                    } else {
                        btn.innerText = "Analyze Trip";
                        alert("City not found. Please try again or click on the map.");
                    }
                })
                .catch(err => {
                    console.error("Search error:", err);
                    btn.innerText = "Analyze Trip";
                    alert("Error finding city. Please check your internet connection.");
                });
        });

    </script>
</body>

</html>